<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Eliza Town</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { overflow: hidden; background: #1a1a2e; }
    canvas { display: block; }
    #loading {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      font-family: Arial, sans-serif;
      font-size: 24px;
      text-align: center;
    }
    #loading .spinner {
      width: 50px;
      height: 50px;
      border: 4px solid #333;
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    #info {
      position: fixed;
      bottom: 20px;
      left: 20px;
      color: white;
      font-family: Arial, sans-serif;
      font-size: 14px;
      background: rgba(0,0,0,0.5);
      padding: 10px 15px;
      border-radius: 8px;
    }
  </style>
</head>
<body>
  <div id="loading">
    <div class="spinner"></div>
    <div>Loading Eliza Town...</div>
  </div>
  <div id="info">
    WASD/Arrows: Move | Mouse: Look | Scroll: Zoom
  </div>

  <script type="importmap">
  {
    "imports": {
      "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
      "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
    }
  }
  </script>

  <script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
    import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

    // Scene setup
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x87CEEB);
    scene.fog = new THREE.Fog(0x87CEEB, 20, 100);

    // Camera
    const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.position.set(15, 12, 15);

    // Renderer
    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(window.devicePixelRatio);
    renderer.shadowMap.enabled = true;
    renderer.shadowMap.type = THREE.PCFSoftShadowMap;
    document.body.appendChild(renderer.domElement);

    // Controls
    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.05;
    controls.maxPolarAngle = Math.PI / 2.1;
    controls.target.set(0, 0, 0);

    // Lighting
    const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
    scene.add(ambientLight);

    const sunLight = new THREE.DirectionalLight(0xffffff, 1.2);
    sunLight.position.set(20, 30, 20);
    sunLight.castShadow = true;
    sunLight.shadow.mapSize.width = 2048;
    sunLight.shadow.mapSize.height = 2048;
    sunLight.shadow.camera.near = 0.5;
    sunLight.shadow.camera.far = 100;
    sunLight.shadow.camera.left = -30;
    sunLight.shadow.camera.right = 30;
    sunLight.shadow.camera.top = 30;
    sunLight.shadow.camera.bottom = -30;
    scene.add(sunLight);

    // Ground plane
    const groundGeometry = new THREE.PlaneGeometry(100, 100);
    const groundMaterial = new THREE.MeshStandardMaterial({
      color: 0x3d6b3d,
      roughness: 0.8
    });
    const ground = new THREE.Mesh(groundGeometry, groundMaterial);
    ground.rotation.x = -Math.PI / 2;
    ground.position.y = -0.01;
    ground.receiveShadow = true;
    scene.add(ground);

    // Loaders
    const gltfLoader = new GLTFLoader();
    let loadedCount = 0;
    let totalToLoad = 0;

    function updateLoading() {
      loadedCount++;
      if (loadedCount >= totalToLoad) {
        document.getElementById('loading').style.display = 'none';
      }
    }

    // Load a GLTF model
    function loadModel(path, position, scale = 1, rotation = 0) {
      totalToLoad++;
      gltfLoader.load(
        path,
        (gltf) => {
          const model = gltf.scene;
          model.position.set(position.x, position.y, position.z);
          model.scale.set(scale, scale, scale);
          model.rotation.y = rotation;
          model.traverse((child) => {
            if (child.isMesh) {
              child.castShadow = true;
              child.receiveShadow = true;
            }
          });
          scene.add(model);
          updateLoading();
        },
        undefined,
        (error) => {
          console.warn('Failed to load:', path);
          updateLoading();
        }
      );
    }

    // Load a GLB character model
    function loadCharacter(name, position, scale = 1, rotation = 0) {
      loadModel(`assets/models/${name}.glb`, position, scale, rotation);
    }

    // Load town building/prop
    function loadTownAsset(category, name, position, scale = 1, rotation = 0) {
      loadModel(`assets/town/${category}/${name}.gltf`, position, scale, rotation);
    }

    // === BUILD THE TOWN ===

    // Place hex tiles for ground (3x3 grid)
    const hexSpacing = 1.73;
    for (let x = -2; x <= 2; x++) {
      for (let z = -2; z <= 2; z++) {
        const offsetX = z % 2 === 0 ? 0 : hexSpacing / 2;
        loadTownAsset('tiles', 'hex_grass', { x: x * hexSpacing + offsetX, y: 0, z: z * 1.5 }, 1);
      }
    }

    // Roads through town center
    loadTownAsset('tiles', 'hex_road_A', { x: 0, y: 0.01, z: 0 }, 1);
    loadTownAsset('tiles', 'hex_road_A', { x: hexSpacing, y: 0.01, z: 0 }, 1);
    loadTownAsset('tiles', 'hex_road_A', { x: -hexSpacing, y: 0.01, z: 0 }, 1);

    // Buildings
    loadTownAsset('buildings', 'building_stage_A', { x: -4, y: 0, z: -3 }, 1, Math.PI/4);
    loadTownAsset('buildings', 'building_stage_B', { x: 4, y: 0, z: -3 }, 1, -Math.PI/4);
    loadTownAsset('buildings', 'building_grain', { x: -5, y: 0, z: 3 }, 1, Math.PI/3);
    loadTownAsset('buildings', 'building_bridge_A', { x: 5, y: 0, z: 4 }, 1);

    // Walls
    loadTownAsset('buildings', 'wall_straight', { x: -8, y: 0, z: 0 }, 1, Math.PI/2);
    loadTownAsset('buildings', 'wall_straight', { x: 8, y: 0, z: 0 }, 1, Math.PI/2);
    loadTownAsset('buildings', 'wall_corner_A_outside', { x: -8, y: 0, z: -6 }, 1);
    loadTownAsset('buildings', 'wall_corner_A_outside', { x: 8, y: 0, z: -6 }, 1, -Math.PI/2);

    // Fences
    loadTownAsset('buildings', 'fence_wood_straight', { x: 2, y: 0, z: 5 }, 1);
    loadTownAsset('buildings', 'fence_wood_straight_gate', { x: 3.5, y: 0, z: 5 }, 1);

    // Props scattered around
    loadTownAsset('props', 'barrel', { x: -3, y: 0, z: 1 }, 1);
    loadTownAsset('props', 'barrel', { x: -2.7, y: 0, z: 0.7 }, 1);
    loadTownAsset('props', 'crate_A_big', { x: 3, y: 0, z: 2 }, 1);
    loadTownAsset('props', 'crate_A_small', { x: 3.3, y: 0, z: 1.7 }, 1);
    loadTownAsset('props', 'sack', { x: 3.5, y: 0, z: 2.2 }, 1);
    loadTownAsset('props', 'wheelbarrow', { x: -2, y: 0, z: -2 }, 1, Math.PI/6);
    loadTownAsset('props', 'bucket_water', { x: 1, y: 0, z: 3 }, 1);
    loadTownAsset('props', 'flag_blue', { x: -4, y: 0, z: -2.5 }, 1);
    loadTownAsset('props', 'flag_red', { x: 4, y: 0, z: -2.5 }, 1);
    loadTownAsset('props', 'weaponrack', { x: -6, y: 0, z: 1 }, 1, Math.PI/2);
    loadTownAsset('props', 'tent', { x: 6, y: 0, z: 2 }, 1, -Math.PI/4);
    loadTownAsset('props', 'target', { x: 7, y: 0, z: -2 }, 1);

    // Nature elements
    loadTownAsset('nature', 'tree_single_A', { x: -7, y: 0, z: 5 }, 1);
    loadTownAsset('nature', 'tree_single_B', { x: 7, y: 0, z: 6 }, 1);
    loadTownAsset('nature', 'trees_A_small', { x: -9, y: 0, z: -4 }, 1);
    loadTownAsset('nature', 'rock_single_A', { x: 6, y: 0, z: -5 }, 1);
    loadTownAsset('nature', 'rock_single_B', { x: -6, y: 0, z: -5 }, 1);
    loadTownAsset('nature', 'hill_single_A', { x: -10, y: 0, z: 2 }, 1);
    loadTownAsset('nature', 'hill_single_B', { x: 10, y: 0, z: -2 }, 1);

    // === PLACE CHARACTERS ===

    // Town square - main characters
    loadCharacter('BlackKnight', { x: -1, y: 0, z: 0 }, 1, Math.PI/4);
    loadCharacter('Witch', { x: 1, y: 0, z: 0.5 }, 1, -Math.PI/6);
    loadCharacter('Vampire', { x: 0, y: 0, z: -1.5 }, 1, Math.PI);

    // Near buildings
    loadCharacter('Hiker', { x: -3.5, y: 0, z: -2.5 }, 1, Math.PI/2);
    loadCharacter('Caveman', { x: 3.5, y: 0, z: -2 }, 1, -Math.PI/3);

    // By the shops/market area
    loadCharacter('Helper_A', { x: -4.5, y: 0, z: 2.5 }, 1, Math.PI/4);
    loadCharacter('Helper_B', { x: -3.5, y: 0, z: 3 }, 1, -Math.PI/6);

    // Guards at walls
    loadCharacter('FrostGolem', { x: -7, y: 0, z: -3 }, 1, Math.PI/2);
    loadCharacter('CombatMech', { x: 7, y: 0, z: -3 }, 1, -Math.PI/2);

    // Wandering the outskirts
    loadCharacter('Protagonist_A', { x: 5, y: 0, z: 3 }, 1, Math.PI);
    loadCharacter('Protagonist_B', { x: -6, y: 0, z: 4 }, 1, 0);
    loadCharacter('Tiefling', { x: 0, y: 0, z: 5 }, 1, Math.PI);

    // Special characters
    loadCharacter('Superhero', { x: 2, y: 0, z: -4 }, 1, Math.PI/3);
    loadCharacter('Clanker', { x: -2, y: 0, z: -5 }, 1, -Math.PI/4);

    // Animation loop
    function animate() {
      requestAnimationFrame(animate);
      controls.update();
      renderer.render(scene, camera);
    }
    animate();

    // Handle resize
    window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });
  </script>
</body>
</html>
